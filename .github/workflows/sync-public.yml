name: Sync to Public

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove private files
        run: |
          # Read .public-ignore and remove listed files/folders
          if [ -f .public-ignore ]; then
            while IFS= read -r pattern || [ -n "$pattern" ]; do
              # Skip comments and empty lines
              [[ "$pattern" =~ ^#.*$ ]] && continue
              [[ -z "$pattern" ]] && continue

              echo "Removing: $pattern"
              rm -rf $pattern
            done < .public-ignore
          fi

          # Remove the ignore file itself
          rm -f .public-ignore

          # Remove GitHub workflows (public repo doesn't need sync workflow)
          rm -rf .github/workflows/sync-public.yml

      - name: Push to public repository
        uses: cpina/github-action-push-to-another-repository@main
        env:
          SSH_DEPLOY_KEY: ${{ secrets.PUBLIC_REPO_DEPLOY_KEY }}
        with:
          source-directory: .
          destination-github-username: ${{ vars.PUBLIC_REPO_OWNER }}
          destination-repository-name: ${{ vars.PUBLIC_REPO_NAME }}
          target-branch: main
          user-email: ${{ vars.GIT_USER_EMAIL }}
          user-name: ${{ vars.GIT_USER_NAME }}
          commit-message: "Sync from private repo"
